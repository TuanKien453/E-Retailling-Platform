@model List<E_Retalling_Portal.Models.ManagerStatisticModel.CustomerStats>

@{
    ViewData["Title"] = " Customer Stats";
    Layout = "~/Views/Shared/ManagerSideBarLayout.cshtml";
}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
        }

        .chart-title {
            text-align: center;
            margin: 20px 0;
            font-size: 24px;
            font-weight: bold;
        }
    </style>
<body>
    <div class="content m-4 pb-3">
        <h2 class="text-center text-primary" style="margin-top: 20px; padding-top: 20px">Customer Statistics</h2>

        <h4>Select Start Date</h4>
        <label for="startYearSelect">Year:</label>
        <select id="startYearSelect" onchange="updateChart()">
            @foreach (var year in Model.Select(m => m.saleYear).Distinct())
            {
                <option value="@year">@year</option>
            }
        </select>
        <label for="startMonthSelect">Month:</label>
        <select id="startMonthSelect" onchange="updateChart()">
            @for (int month = 1; month <= 12; month++)
            {
                <option value="@month">@month</option>
            }
        </select>
        <label for="startDaySelect">Day:</label>
        <select id="startDaySelect" onchange="updateChart()">
            @for (int day = 1; day <= 31; day++)
            {
                <option value="@day">@day</option>
            }
        </select>

        <h4>Select End Date</h4>
        <label for="endYearSelect">Year:</label>
        <select id="endYearSelect" onchange="updateChart()">
            @foreach (var year in Model.Select(m => m.saleYear).Distinct())
            {
                <option value="@year">@year</option>
            }
        </select>
        <label for="endMonthSelect">Month:</label>
        <select id="endMonthSelect" onchange="updateChart()">
            @for (int month = 1; month <= 12; month++)
            {
                <option value="@month">@month</option>
            }
        </select>
        <label for="endDaySelect">Day:</label>
        <select id="endDaySelect" onchange="updateChart()">
            @for (int day = 1; day <= 31; day++)
            {
                <option value="@day">@day</option>
            }
        </select>

        <canvas id="CustomerChart" width="400" height="250"></canvas>

        <script>
            const customerData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model));

            let CustomerChart;

            function renderChart(startDate, endDate) {
                const filteredData = customerData.filter(item => {
                    const saleDate = new Date(item.saleYear, item.saleMonth - 1);
                    return saleDate >= startDate && saleDate <= endDate;
                });

                const labels = filteredData.map(item => `${item.saleMonth}/${item.saleYear}`);
                const customers = filteredData.map(item => item.totalCustomers);

                const ctx = document.getElementById('CustomerChart').getContext('2d');

                if (CustomerChart) {
                    CustomerChart.destroy();
                }

                CustomerChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Customers',
                            data: customers,
                            backgroundColor: 'rgba(153, 102, 255, 0.6)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month/Year'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Number of Customers'
                                },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                        }
                    }
                });
            }

            function updateChart() {
                const startYear = document.getElementById('startYearSelect').value;
                const startMonth = document.getElementById('startMonthSelect').value;
                const startDay = document.getElementById('startDaySelect').value;
                const endYear = document.getElementById('endYearSelect').value;
                const endMonth = document.getElementById('endMonthSelect').value;
                const endDay = document.getElementById('endDaySelect').value;

                const startDate = new Date(`${startYear}-${startMonth.padStart(2, '0')}-${startDay.padStart(2, '0')}`);
                const endDate = new Date(`${endYear}-${endMonth.padStart(2, '0')}-${endDay.padStart(2, '0')}`);

                const today = new Date();
                const initialStartDate = new Date(today);
                const initialEndDate = new Date(today);

                initialStartDate.setFullYear(today.getFullYear() - 1, today.getMonth(), today.getDate());
                initialEndDate.setFullYear(today.getFullYear(), today.getMonth(), today.getDate());

                if (startDate > endDate) {
                    alert("Start Date can not be greater than End Date");

                    document.getElementById('startYearSelect').value = initialStartDate.getFullYear();
                    document.getElementById('startMonthSelect').value = initialStartDate.getMonth() + 1;
                    document.getElementById('startDaySelect').value = initialStartDate.getDate();

                    document.getElementById('endYearSelect').value = initialEndDate.getFullYear();
                    document.getElementById('endMonthSelect').value = initialEndDate.getMonth() + 1;
                    document.getElementById('endDaySelect').value = initialEndDate.getDate();

                    return; 
                }

                renderChart(startDate, endDate);
            }

            const today = new Date();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 1);

            document.getElementById('startYearSelect').value = oneYearAgo.getFullYear();
            document.getElementById('startMonthSelect').value = oneYearAgo.getMonth() + 1;
            document.getElementById('startDaySelect').value = oneYearAgo.getDate();

            document.getElementById('endYearSelect').value = today.getFullYear();
            document.getElementById('endMonthSelect').value = today.getMonth() + 1;
            document.getElementById('endDaySelect').value = today.getDate();

            updateChart();
        </script>

        <div style="display: flex; justify-content: flex-end; margin-bottom: 20px; margin-right: 20px;">
            <a href="@Url.Action("Index", "ManagerStatistic")" style="text-decoration: none; color: #007bff; border: 1px solid #007bff; border-radius: 5px; padding: 10px;">Back to List Shops</a>
        </div>
    </div>
</body>
</html>